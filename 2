package main

import (
	"fmt"
	"log"
	"strings"

	"github.com/xuri/excelize/v2"
)

func main() {
	inputPath := "/home/idris/GolandProjects/Raspisanie/123.xlsx"
	outputPath := "/home/idris/GolandProjects/Raspisanie/123_Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ð½Ð¾Ðµ.xlsx"

	f, err := excelize.OpenFile(inputPath)
	if err != nil {
		log.Fatalf("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ: %v", err)
	}
	defer f.Close()

	// ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð»Ð¸ÑÑ‚
	for _, sheet := range f.GetSheetList() {
		fmt.Printf("ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð»Ð¸ÑÑ‚: %s\n", sheet)

		// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ ÑÑ‚Ñ€Ð¾ÐºÐ¸
		rows, err := f.GetRows(sheet)
		if err != nil {
			log.Printf("ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ð»Ð¸ÑÑ‚Ð° %s: %v", sheet, err)
			continue
		}

		// Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð½Ð¾Ð¼ÐµÑ€Ð° ÑÑ‚Ñ€Ð¾Ðº Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ (ÑÐ½Ð¸Ð·Ñƒ Ð²Ð²ÐµÑ€Ñ…!)
		var toDelete []int
		for i, row := range rows {
			// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼: ÐµÑÑ‚ÑŒ Ð»Ð¸ "(ÑƒÑ€Ð¾Ðº)" Ð² ÑÑ‡ÐµÐ¹ÐºÐ°Ñ…
			for _, cell := range row {
				if strings.TrimSpace(cell) == "(ÑƒÑ€Ð¾Ðº)" {
					toDelete = append(toDelete, i+1) // Excel: 1-based
					fmt.Printf("âŒ Ð¡Ñ‚Ñ€Ð¾ÐºÐ° %d Ð¿Ð¾Ð¼ÐµÑ‡ÐµÐ½Ð° Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ: %v\n", i+1, row)
					break
				}
			}
		}

		// Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÐ¸ ÑÐ½Ð¸Ð·Ñƒ Ð²Ð²ÐµÑ€Ñ… (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð½Ð´ÐµÐºÑÑ‹ Ð½Ðµ ÑÐ±Ð¸Ð²Ð°Ð»Ð¸ÑÑŒ)
		for i := len(toDelete) - 1; i >= 0; i-- {
			rowNum := toDelete[i]
			f.RemoveRow(sheet, rowNum)
		}

		// âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑˆÐ¸Ñ€Ð¸Ð½Ñ‹ ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº
		columns := []string{"C", "E", "G", "I", "K"}
		for _, col := range columns {
			f.SetColWidth(sheet, col, col, 75)
		}

		// âœ… ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÑˆÑ€Ð¸Ñ„Ñ‚Ð° Times New Roman
		styleID, err := f.NewStyle(&excelize.Style{
			Font: &excelize.Font{
				Family: "Times New Roman",
				Size:   11,
			},
		})
		if err != nil {
			log.Printf("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÑ‚Ð¸Ð»Ñ: %v", err)
		} else {
			// ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ ÐºÐ¾ Ð²ÑÐµÐ¼Ñƒ Ð»Ð¸ÑÑ‚Ñƒ
			// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ ÑÑ‡ÐµÐ¹ÐºÑƒ
			if len(rows) > 0 {
				lastRow := len(rows) - len(toDelete) // Ð¿Ñ€Ð¸Ð±Ð»Ð¸Ð·Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾
				if lastRow < 1 {
					lastRow = 1
				}
				lastCol, _ := excelize.CoordinatesToCellName(len(rows[0]), lastRow)
				f.SetCellStyle(sheet, "A1", lastCol, styleID)
			}
		}
	}

	// Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼
	if err := f.SaveAs(outputPath); err != nil {
		log.Fatalf("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ: %v", err)
	}

	fmt.Println("ðŸŽ‰ Ð“Ð¾Ñ‚Ð¾Ð²Ð¾:", outputPath)
}
